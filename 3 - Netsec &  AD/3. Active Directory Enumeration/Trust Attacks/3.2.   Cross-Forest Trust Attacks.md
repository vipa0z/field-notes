
# All the Possible Cross-Forest Attacks

- cross-forest kerberoasting
- cracked hash can be used to attempt a password spray against the root domain
- Admin password Re-Use & Group Membership
- sid history abuse also possible but not covered in module


## Cross-Forest Kerberoasting

Kerberos attacks such as Kerberoasting and ASREPRoasting can be performed across trusts, depending on the trust direction. In a situation where you are positioned in a domain with either an **inbound or bidirectional domain/forest trust**, you can likely perform various attacks to gain a foothold. Sometimes you cannot escalate privileges in your current domain, but instead can obtain a Kerberos ticket and crack a hash for an administrative user in another domain that has Domain/Enterprise Admin privileges in both domains.

---
## Testing for Cross-Forest Kerberoasting

We can utilize PowerView to enumerate accounts in a target domain that have SPNs associated with them.
## targeting child domain
### Powerview - Enumerating Accounts for Associated SPNs Using Get-DomainUser IN CHILD DOMAIN

```powershell-session
> Get-DomainUser -SPN -Domain FREIGHTLOGISTICS.LOCAL | select SamAccountName
```

### Target an Account with SPN
```powershell-session
> Get-DomainUser -Domain FREIGHTLOGISTICS.LOCAL -Identity mssqlsvc |select samaccountname,memberof

> mssqlsvc       CN=Domain Admins,CN=Users,DC=FREIGHTLOGISTICS,DC=LOCAL
```
We see that there is one account with an SPN in the target domain. A quick check shows that this account is a member of the Domain Admins group in the target domain, so if we can Kerberoast it and crack the hash offline, we'd have full admin rights to the target domain.
#### Performing a Kerberoasting Attacking with Rubeus Using /domain Flag
`Kerbroast ` rubeas cross-forest kerberoast
```powershell-session
> .\Rubeus.exe kerberoast /domain:FREIGHTLOGISTICS.LOCAL /user:mssqlsvc /nowrap
```
We could then run the hash through Hashcat. If it cracks, we've now quickly expanded our access to fully control two domains by leveraging a pretty standard attack and abusing the authentication direction and setup of the bidirectional forest trust.

---
## Admin Password Re-Use & Group Membership`
From time to time, we'll run into a situation where there is a bidirectional forest trust managed by admins from the same company.If we can take over Domain A and obtain cleartext passwords or NT hashes for either the built-in Administrator account (or an account that is part of the Enterprise Admins or Domain Admins group in Domain A), and Domain B has a highly privileged account with the same name, then it is worth checking for password reuse across the two forests.

### password re-use
its worth checking admins group for each domain.

sometimes A domain would have a user named `adm_bob.smith` in the Domain Admins group, and Domain B had a user named `bsmith_admin`. Sometimes, the user would be using the same password in the two domains, and owning Domain A instantly gave me full admin rights to Domain B.
#### Group Membership
We may also see users or admins from Domain A as members of a group in Domain B. Only `Domain Local Groups` allow security principals from outside its forest. We may see a Domain Admin or Enterprise Admin from Domain A as a member of the built-in Administrators group in Domain B in a bidirectional forest trust relationship. If we can take over this admin user in Domain A, we would gain full administrative access to Domain B based on group membership.
### Enumerate foreign Group Members
We can use the PowerView function [Get-DomainForeignGroupMember](https://powersploit.readthedocs.io/en/latest/Recon/Get-DomainForeignGroupMember) to enumerate groups with users that do not belong to the domain, also known as `foreign group membership`

enumerating groups not belonging to freightlogistiscs forest
```powershell-session
Get-DomainForeignGroupMember -Domain FREIGHTLOGISTICS.LOCAL
```
![[Pasted image 20250930221525.png]]
The above command output shows that the built-in Administrators group in `FREIGHTLOGISTICS.LOCAL` has the built-in Administrator account for the `ad.someorg.local` domain as a member. We can verify this access using the `Enter-PSSession` cmdlet to connect over WinRM.
### Accessing DC03 Using Enter-PSSession

```powershell-session
Enter-PSSession -ComputerName ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL -Credential INLANEFREIGHT\administrator

[ACADEMY-EA-DC03.FREIGHTLOGISTICS.LOCAL]: PS C:\Users\administrator.INLANEFREIGHT\Documents> whoami
inlanefreight\administrator
```

---
## SID HISTORY ABUSE Cross-Forest
SID History can also be abused across a forest trust. If a user is migrated from one forest to another and SID Filtering is not enabled, it becomes possible to add a SID from the other forest, and this SID will be added to the user's token when authenticating across the trust.

If the SID of an account with administrative privileges in Forest A is added to the SID history attribute of an account in Forest B, assuming they can authenticate across the forest, then this account will have administrative privileges when accessing resources in the partner forest. 

In the below diagram, we can see an example of the `jjones` user being migrated from the `ad.someorg.local` domain to the `CORP.LOCAL` domain in a different forest. If SID filtering is not enabled when this migration is made and the user has administrative privileges (or any type of interesting rights such as ACE entries, access to shares, etc.) in the `ad.someorg.local` domain, then they will retain their administrative rights/access in `ad.someorg.local` while being a member of the new domain, `CORP.LOCAL` in the second forest.

### Diargram showing migrated user from 1 forest to another

![Diagram showing trust relationship between ad.someorg.local and CORP.LOCAL domains, with user migration due to merger. Includes user SIDs and resources.](https://academy.hackthebox.com/storage/modules/143/sid-history.png)

cross forest kerberoasting
```shell-session
$ $ GetUserSPNs.py -request -target-domain FREIGHTLOGISTICS.LOCAL ad.someorg.local/wley -outputfile hashes_spns
```
---
